<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Test-0-Sterone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/theme/black.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/monokai.css"
    />
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h1>Ceci n'est pas un test</h1>
        </section>

        <section>
          <h1>ğŸ§ª Les tests</h1>
          <p>Pourquoi, comment et avec quoi tester ses applications ?</p>
        </section>

        <section>
          <section>
            <h2>Pourquoi Ã©crire des tests ?</h2>
            <h6>version idÃ©ale</h6>
            <br />
            <ul>
              <li>âœ… Garantir le bon fonctionnement du code</li>
              <li>ğŸ› ï¸ Refactorer sans crainte</li>
              <li>ğŸ“ˆ AccÃ©lÃ©rer le dÃ©veloppement long-terme</li>
              <li>ğŸ§˜â€â™€ï¸ RÃ©duire le stress en production</li>
            </ul>
          </section>

          <section>
            <h2>Pourquoi Ã©crire des tests ?</h2>
            <h6>version rÃ©alitÃ©</h6>
            <br />
            <ul>
              <li>ğŸ˜µâ€ğŸ’« L'erreur est humaine, on ne pense pas toujours Ã  tout</li>
              <li>ğŸ” Les applications sont toujours plus compliquÃ©es</li>
              <li>ğŸ§¡ Travail en Ã©quipe modulaire et solide</li>
              <li>ğŸ Trouver des bugs Ã  l'Ã©criture des tests</li>
            </ul>
          </section>
        </section>

        <section>
          <section>
            <h2>Types de tests</h2>
            <br />
            <ul>
              <li>
                <strong>Test unitaire</strong> : teste une seule classe ou
                mÃ©thode
              </li>
              <li><strong>Test fonctionnel</strong> : teste un contrÃ´leur</li>
              <li>
                <strong>Test dâ€™intÃ©gration</strong> : simule lâ€™interaction
                utilisateur (cotÃ© front)
              </li>
              <li><strong>Test systÃ¨me</strong> : test de bout en bout</li>
            </ul>
          </section>
          <section>
            <h2>Types de tests</h2>
            <h6>version Jules</h6>
            <br />
            <ul>
              <li>
                <strike
                  ><strong>Test unitaire</strong> : teste une seule classe ou
                  mÃ©thode</strike
                >
              </li>
              <li><strong>Test fonctionnel</strong> : teste un contrÃ´leur</li>
              <li>
                <strike
                  ><strong>Test dâ€™intÃ©gration</strong> : simule lâ€™interaction
                  utilisateur</strike
                >
              </li>
              <li>
                <strike
                  ><strong>Test systÃ¨me</strong> : test de bout en bout</strike
                >
              </li>
            </ul>
          </section>
          <section>
            <h2>Pourquoi ?</h2>
            <br />
            <ul>
              <li>
                Les controllers englobe tout l'acheminement et la procÃ©dure
                d'une requÃªte jusqu'a sa rÃ©ponse.
              </li>
              <li>Le plus gros ratio Temps / EfficacitÃ© (Ã  titre personnel)</li>
            </ul>
          </section>

          <section>
            <h2>Exemple: '/api/personnes/1'</h2>
            <br />
            <ul>
              <li>Router</li>
              <li>ApplicationController</li>
              <li>PersonnesController</li>
              <li>Policies</li>
              <li>Logique mÃ©tier sur le modÃ¨le Personne</li>
              <li>RÃ©ponse</li>
            </ul>
          </section>
        </section>

        <section>
          <section>
            <h2>Anatomie d'un test</h2>
              <pre>
                <code class="language-ruby">require "test_helper"
  
class PersonnesControllerTest < ActionDispatch::IntegrationTest

  test "test exemple" do
    get("/api/personnes/profils")
    assert_response :unauthorized
  end

end</code>
              </pre>
          </section>

          <section>
            <h2>Anatomie d'un test</h2>
            <h6>Les asserts</h6>
            <br />
            <ul>
              <li><code>assert</code> : vÃ©rifie qu'une condition est vraie</li>
              <li><code>assert_equal</code> : compare deux valeurs</li>
              <li><code>assert_nil</code> : vÃ©rifie quâ€™une valeur est <code>nil</code></li>
              <li><b><code>assert_response</code> : vÃ©rifie la rÃ©ponse d'une requÃªte</b></li>
            </ul>
          </section>
          
          <section>
            <h2>Anatomie d'un test</h2>
            <h6>Le callback setup</h6>
            <ul>
              <li>S'exÃ©cute avant chaque test</li>
              <li>IdÃ©al pour la prÃ©paration des objets</li>
              <li>Chaque test reste isolÃ© : nouvelle instance Ã  chaque fois</li>
            </ul>
          </section>

          <section>
            <h2>Anatomie d'un test</h2>
            <h6>Les callbacks</h6>
            <pre>
              <code class="language-ruby">require "test_helper"

class PersonnesControllerTest < ActionDispatch::IntegrationTest

setup do
  @personne = Personne.find(...)
end

# les tests auront accÃ¨s Ã  @personne

end</code>
            </pre>
          </section>
        </section>

        <section>
          <section>
            <h2>ğŸ”§ Les fixtures</h2>
            <ul>
              <li>ğŸ“ Fichiers YML utilisÃ©s pour peupler la base de test</li>
              <li>ğŸ“¦ Fournissent des donnÃ©es prÃªtes Ã  lâ€™emploi dans les tests</li>
              <li>ğŸ”„ ChargÃ©s automatiquement avant chaque test</li>
            </ul>
          </section>
          
          <section>
            <h3>Exemple de fixture (users.yml)</h3>
            <pre><code class="language-yaml">user_admin:
  nom_complet: "User Admin"
  courriel: "testadmin@chu-reims.fr"
  windows: "0000001"
  id_res: "0000001"
  is_admin: true

user_standard:
  nom_complet: "User Standard"
  courriel: "teststandard@chu-reims.fr"
  windows: "0000002"
  id_res: "0000002"
  is_admin: false</code></pre>
          </section>
          
          <section>
            <h3>Utilisation dans les tests</h3>
            <pre><code class="language-ruby">test "show user exemple" do
  user = users(:user_standard)

  # Sans JWT
  get("/api/users/#{user.id}")
  assert_response :unauthorized
end</code></pre>
          </section>
        </section>

        <section>
          <section>
            <h2>ğŸ’‰ Les helpers, c'est quoi ?</h2>
            <br />
            <div>Classes mettant Ã  disposition des mÃ©thodes utilitaires dans les tests</div>
          </section>

          <section>
            <h2>ğŸ’‰ Helpers</h2>
            <h6>Utilisation courante</h6>
            <br />
            <ul>
              <li>GÃ©nÃ©ration de JWT pour un <i>faux</i> utilisateur</li>
              <li>Modification et rÃ©initialisation des droits utilisateur sur demande</li>
              <li>Gestionnaire de fichiers</li>
            </ul>
          </section>

          <section>
            <h2>ğŸ’‰ Exemple</h2>
            <pre>
              <code class=language-ruby>module AuthHelper
  def get_jwt_admin
    get_jwt(users(:user_admin))
  end
  
  private
  def get_jwt(user)
    payload = {sub: user.windows, aud: nil, iat: Time.now.to_i, exp: iat + 8.hours.to_i, id_res: user.id_res}
    secret = Rails.application.credentials.jwt_secret
    { Authorization: JWT.encode(payload, secret, 'HS256') }
  end
end</code></pre>
          </section>

          <section>
            <h2>ğŸ’‰ Exemple</h2>
            <pre>
              <code class=language-ruby>require "test_helper"
require "test_helpers/auth_helper"

class AdminControllerTest < ActionDispatch::IntegrationTest
  include AuthHelper

  test "exemple" do
    post("/api/admin/import-truc", headers: get_jwt_admin)
    assert_response :success
  end

end</code></pre>
          </section>
        </section>

        <section>
          <section>
            <h2>ğŸ–¥ï¸ CLI</h2>
            <ul>
              <li><code>bin/rails test</code> : exÃ©cute tous les tests</li>
              <li><code>bin/rails test test/models/user_test.rb</code> : un fichier spÃ©cifique</li>
              <li><code>bin/rails test -n test_nom_du_test</code> : un test prÃ©cis par nom</li>
              <li><code>bin/rails test:controllers</code> : une catÃ©gorie de tests</li>
            </ul>
          </section>
          
          <section>
            <h3>ğŸ–¥ï¸ CLI</h3>
            <ul>
              <li>Ajouter <code>--verbose</code> pour plus de dÃ©tails</li>
              <li>Utiliser <code>--fail-fast</code> pour s'arrÃªter au 1er Ã©chec</li>
              <li>Utiliser <code>--pride</code> pour faire la ğŸ‰</li>
            </ul>
          </section>
        </section>

        <section>
          <h2>Bonnes pratiques</h2>
          <ul>
            <li>ğŸ” ExÃ©cuter les tests automatiquement (CI/CD)</li>
            <li>ğŸ’¬ Nommer clairement les tests</li>
            <li>ğŸ“ Garder les tests rapides</li>
            <li>ğŸ” Ne pas tester les implÃ©mentations mais les comportements</li>
            <li>â—ï¸ Tester toutes les possibilitÃ©es</li>
          </ul>
        </section>



        <section>
          <h2>Conclusion</h2>
          <p></p>
          <p>Les tests, Ã§a dÃ©chire.</p>
          <p><a href="https://guides.rubyonrails.org/testing.html">Documentation</a></p>
        </section>

        <section>
          <h2>Bonus</h2>
          <pre># Running:
.............
Finished in 1.230508s, 12.9880 runs/s, 41.0881 assertions/s.
13 runs, 14 assertions, 1 failures, 0 errors, 0 skips

Failure: Faute Ã  "<i>Tester toutes les possibilitÃ©<b><u>e</u></b>s</i>"</pre>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4/dist/reveal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4/plugin/highlight/highlight.min.js"></script>
    <script>
      Reveal.initialize({
        hash: true,
        slideNumber: true,
        plugins: [RevealHighlight],
      });
    </script>
  </body>
</html>
